---
title: "Biostat 203B Homework 2 Solution"
author: Kelsey Ishimoto
subtitle: Due Feb 10 @ 11:59PM
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup, eval=TRUE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-0.4"
}
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

**Solution:**
<p align="center">
<img src="./MIMIC-IV_PhysioNetCredential_Ishimoto.png" height="500">
</p>


## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference?

In this homework, we stick to the tidyverse. 

**Solution: (editing needed later)**

```{r, eval=FALSE}
system.time(read.csv(str_c(mimic_path, "/core/admissions.csv.gz")))

system.time(read_csv(str_c(mimic_path, "/core/admissions.csv.gz")))

system.time(fread(str_c(mimic_path, "/core/admissions.csv.gz")))
```

The function `read.csv` took about 46 seconds to run on my machine. Whereas `read_csv` took only about 5 seconds to run. And `fread` took about 2 seconds to run.

**change eval = FALSE later -- I just want to speed up my knitting while doing this homework.**

## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs:   

- how many unique `stay_id`?  
- how many unique `subject_id`?  
- length of ICU stay  
- first ICU unit  
- last ICU unit  

**Solution:**
First read in `icustays` data:

```{r}
icustays_tble <- read_csv(str_c(mimic_path, "/icu/icustays.csv.gz"))
print(icustays_tble, width = Inf)
```

How many unique `stay_id`s?
```{r}
icustays_tble %>% 
  distinct(stay_id) %>% 
  nrow()
```
There are 69,619 unique `stay_id`s. It seems that each row is a unique ICU stay. (number of rows is the same as the number of rows of original tibble)

How many unique `subject_id`s?
```{r}
icustays_tble %>% 
  distinct(subject_id) %>% 
  nrow()
```
There are 50,048 unique `subject_id`s. Since the number of unique `stay_id`s is greater than the number of unique `subject_id`s, one patient can have more than one ICU stays.

-length of ICU stays (histogram)
```{r}
fivenum(icustays_tble$los)

icustays_tble %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = los)) +
  xlab("Length of stay (days)")
```

We can see from the histogram above that the length of ICU stays is very positively skewed. The median of the length of ICU stays is 2.06 days, and about half of our data lie between 1.13 days and 4.20 days. The minimum length of stay was less than half a day, and the maximum length of stay was almost 600 days. 


Why so many high `los`? Let's see those outliers more than 100 days. 

```{r}
icustays_tble %>% 
  select(los) %>% 
  filter(los >=100)
```

- First ICU unit
```{r}
icustays_tble %>% 
  select(first_careunit) %>% 
  ggplot(aes(x = first_careunit)) +
  geom_bar() + 
  xlab("First Care Unit") + 
  theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust=1))
```

We can see from the bar plot that the majority of the first care units were Medical Intensive Care Unit (MICU).


- Last ICU unit

```{r}
icustays_tble %>% 
  select(last_careunit) %>% 
  ggplot(aes(x = last_careunit)) +
  geom_bar() + 
  xlab("Last Care Unit") + 
  theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust=1))
```

The relative counts of the last care units is similar to the first care units, however, Medicine and PACU that appear in the first care unit bar plot is not seen in the last care unit bar plot.

## Q4. `admission` data

Information of the patients admitted into hospital is available in `ADMISSION.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  
- number of deaths in each year  
- admission type  
- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on unique patients. 

**Solution:**

First read in the data:
```{r}
admissions_tble <- read_csv(str_c(mimic_path, "/core/admissions.csv.gz"))
```

As we have seen before, the same patient could have several hospital stays. So first, I want to decide which variables I will need to only look at distinct `subject_id`s for. In order to do this, I want to look at a sample of the data:

```{r}
admissions_tble %>% 
  filter(hospital_expire_flag == 1) %>% 
  head()
# 16441855, 14536465, 11475290
admissions_tble %>% 
  select(subject_id, admittime, dischtime, admission_location, discharge_location) %>%
  filter(subject_id == 11707036) %>% 
  arrange(admittime) %>% 
  print(width = Inf)
```

A single patient may have been admitted to the hospital several times, but sometimes, the second admission is just that patient being transferred to another hospital department, and other times it is the case that patient is discharged home and then they end up at the hospital again. Since this is the case, I will include the whole dataset for most analysis other than demographic information. For the summary of death, I will also summarize by unique patients. 

- Admission Year
```{r}
admissions_tble %>% 
  ggplot(aes(x = year(admittime))) +
  geom_histogram(aes(y = ..count..), bins = 30,
                 color = "black", fill = "light blue") + 
  xlab("Admission Year") + 
  ylab("Total Count")
```

- Admission Month

```{r}
admissions_tble %>% 
  ggplot(aes(x = month(admittime, labe = TRUE, abbr = FALSE))) +
  geom_bar(color = "black", fill = "light blue") + 
  xlab("Admission Month") + 
  ylab("Total Count") + 
  theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust=1))
```

- admission month day

```{r}
admissions_tble %>% 
  ggplot(aes(x = mday(admittime))) +
  geom_bar(color = "black", fill = "light blue") + 
  xlab("Admission Month Day") + 
  ylab("Total Count")
```

We can see that there are less admissions at hte end of the month. This is because not all months have a 31st day, and similarly, the month of February is short; it never has the 30th or 31st day, and only has the 29th day every fourth year. This is reflected in the above graph where the 29th, 30th, and 31st days have less admissions than the rest of the month days. For the other days, it seems that other days have about the same admission count. 

- admission week day  

```{r}
admissions_tble %>% 
  ggplot(aes(x = wday(admittime, label = TRUE, abbr = FALSE))) +
  geom_bar(color = "black", fill = "light blue") + 
  xlab("Admission Week Day") + 
  ylab("Total Count")
```

All the week days have a similar count of patients, indicating that there seems to be a uniform distribution of admissions across week days. 

- admission hour (anything unusual?) 

```{r}
admissions_tble %>% 
  ggplot(aes(x = hour(admittime))) +
  geom_histogram(aes(y = ..count..), bins = 12, 
                 color = "black", fill = "light blue") + 
  xlab("Admission Hour") + 
  ylab("Total Count")
```

There seems to be an unusually large number of patients that were admitted at midnight. This might be the time the hospital wrote down when the actual admission time was not known. There is also a peak of admission hour around 7am. This might be because that is when people wake up and find something wrong with themselves or their family member. Similarly, there is another peak of admissions in the evening. This might be that people found something wrong with themselves but didn't go to the hospital to get admitted until after their work was over, or didn't find their family member at home until they got off of work. 


- number of deaths in each year  

First I'm going to check whether the number of deaths is the same when we make the calculations with `deathtime` not missing and when we use `hospital_expire_flag` = 1
```{r}
admissions_tble %>% 
  summarise(flagdead = sum(hospital_expire_flag), timedead = sum(!is.na(deathtime)))
```

We can see that the results are not the same when we use these two different variables. Using the `hospital_expire_flag`, there seems to be more people who did not survive their hospital stay.

```{r}
admissions_tble %>% 
  select(dischtime, deathtime, hospital_expire_flag) %>% 
  filter(hospital_expire_flag == 1 & is.na(deathtime))
```

Reading the documentation of the MIMIC-IV data, it says, "Note that `deathtime` is only present if the patient died in-hospital, and is almost always the same as the patientâ€™s `dischtime`. However, there can be some discrepancies due to typographical errors." For all the data points where `deathtime` is missing but `hospital_expire_flag` = 1 (indicating the patient died in the hospital), a discharge time still exists, and from the documentation, it seems that time of death is usually agrees with discharge time unless there are typographical errors. It could be that the hospital worker only wrote down the discharge time assuming that people would know that would be the same time of death for patients who did not survive their hospital stay. For this reason, I will use `hospital_expire_flag` as the indicator of death.

```{r}
yeardeaths <- admissions_tble %>% 
  group_by(year(dischtime)) %>% 
  summarise(dead = sum(hospital_expire_flag))

names(yeardeaths) <- c('year', 'dead')

yeardeaths %>% 
  ggplot(aes(x = year, y = dead)) + 
  geom_col(color = "black", fill = "light blue") + 
  xlab("Year") + 
  ylab("Number of Deaths")
```

The shape of this graph is similar to the shape of the admission year graph. Indicating that the rate of deaths per admissions per year is around the same across the years.

- admission type

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = admission_type)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust=1)) +
  xlab("Admission Type") +
  ylab("Count")
```

Most patients seemed to have been admitted through Elective, EU Observation, or EW Emergency.



- number of admissions per patient  

```{r}
admissions_tble %>% 
  count(subject_id) %>% 
  ggplot(aes(x = subject_id, y = n)) +
  geom_line() + 
  xlab("Subject ID") + 
  ylab("Number of Admissions")
```

Most patients seemed to have been only admitted a few times while other patients were admitted dozens of times, and other patients were admitted over a hundred times. As we have investigated before, "admissions" also refers to times when patients are transferred to another hospital department, which can account for some of the multiple hospital admissions, but the higher number of admissions seems very high. 


- admission location  

```{r}
admissions_tble %>% 
  #distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = admission_location)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 70, vjust = 1, hjust=1)) +
  xlab("Admission Location") +
  ylab("Count")
```

Most of the patients were admitted either through the emergency room or physician referral.


- discharge location  

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = discharge_location)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  xlab("Discharge Location") +
  ylab("Count")
```

Most patients were discharged home or the discharge location was not applicable. This not applicable could have been that they were transferred to another part of the hospital perhaps?

- insurance 

Each patient should have the same insurance across all of their hospital stays, so I chose to only look at unique `subject_id`s for this summary of `insurance`.

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = insurance)) + 
  geom_bar() + 
  xlab("Insurance") +
  ylab("Count")
```

The majority of patients had insurance other than Medicaid and Medicare. 

- language 

Again, only looking at unique `subject_id`s. 

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = language)) + 
  geom_bar() + 
  xlab("Language") +
  ylab("Count")
```

The overwhelming majority of patients spoke English.

- martial status:
Again, only looking at unique `subject_id`s

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = marital_status)) + 
  geom_bar() + 
  xlab("Marital Status") +
  ylab("Count")
```

Most patients were either married or single. But also, a lot of patients were listed as `NA` which I'm not sure what that means. It could be that the patient was too young to be married or that the marital status was unknown.

- ethnicity  

```{r}
admissions_tble %>% 
  distinct(., subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = ethnicity)) + 
  geom_bar() + 
  xlab("Ethnicity") +
  ylab("Count") + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```

Most people were white. 

- death

```{r}
admissions_tble %>%  
  summarize(death_count = sum(hospital_expire_flag))

admissions_tble %>% 
  distinct(., subject_id) %>% 
  nrow()

ggplot()+
  geom_col(aes(x = c("Died", "Survived"), y = c(9369, 257366-9369))) +
  xlab("Mortality") + 
  ylab("Count")
```

The total number of unique patients is 257,366 people. Of those patients, 9,369 (3.64%) of them ended up dying in the hospital. But as we can see in the graph, the overwhelming majority of patients survived (96.36%). 


## Q5. `patient` data

Explore `patients.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/core/patients/>) and summarize following variables using appropriate numerics and graphs:  

- `gender`  
- `anchor_age` (explain pattern you see)

**Solution:**
- need to understand what `anchor_age` means: `anchor_age` is the age of a patient in the provided `anchor_year`

```{r}
patients_tble <- read_csv(str_c(mimic_path, "/core/patients.csv.gz"))
print(patients_tble, width = Inf)
```

-Gender


```{r}
patients_tble %>% 
  ggplot(aes(x = gender)) + 
  geom_bar(color = "black", fill = "light blue") + 
  xlab("Gender") +
  ylab("Count") + 
  scale_x_discrete(labels = c("Female", "Male"))
```

The genders of the patients are split fairly evenly between male and female.


- Anchor Age

```{r}
patients_tble %>% 
  ggplot(aes(x = anchor_age)) +
  geom_histogram(color = "black", fill = "light blue", bin = 20) +
  xlab("Age at Anchor Year") + 
  ylab("Count")
```

Many patients have an age of zero during their anchor year. This might be because that would make it easier to calculate their actual age during a certain hospital stay since their actual age would just be the difference between the shifted year in their chart and their anchor year. The other strange thing is that there is little to no `anchor_age`s in the range of 1 year to 20 years. This could be because for some patients, their ages were set to zero at their anchor year, but for other patients, their ages were set to their actual age according to their anchor year which could have been the same as their year of admission to the hospital. 


## Q6. Lab results

`labevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/hosp/labevents/>) contains all laboratory measurements for patients. 

We are interested in the lab measurements of creatinine, potassium, sodium, chloride, bicarbonate, hematocrit, white blood cell count, glucose, magnesium, calcium, phosphorus, and lactate. Find the `itemid`s of these lab measurements from `d_labitems.csv.gz` and retrieve a subset of `labevents.csv.gz` only containing these items.

**Solution Notes:**
- there are many lab events, but collect the above lab measurements from those two data files.
- tidyverse merging and whatnot
- the data files, even after compression, are very large, and there is some trouble reading the data

The following file is so large. Normally we would want to use a database in order to read in this file. But without using a database.
```{r, eval = FALSE}
labevents_tble <- read_csv(str_c(mimic_path, "/hosp/labevents.csv.gz"))
```

Let's just take a look at the first few lines of the labevents data:
```{r, eval = FALSE}
system(str_c("zcat < ", shQuote(str_c(mimic_path, "/hosp/labevents.csv.gz")),
             " | head"), intern = TRUE)
```

We only need some variables: subject id, labevent id, hadm id, itemid, charttime, valuenum

Dr. Zhou used `read_csv` and only read in those above columns --> but it's still too much memory

use data.table

Try running the following code on my own computer, or try removing all other variables int he environment (top right window), and see if 

Code from Dr. Zhou:
took 200 seconds
```{r, eval=FALSE}
if (!file.exists("labevents_icustays.csv.gz")) {
  labevents_tble <- fread(str_c(mimic_path, "/hosp/labevents.csv.gz"),
                        select = c("subject_id", "hadm_id", "itemid", 
                               "charttime", "valuenum"),
                        nThread = 4)
  labevents_tble %>% 
  semi_join(icustays_tble, by = c("subject_id", "hadm_id")) %>% 
  fwrite("labevents_icustays.csv.gz", nThread = 4)
}
```

From Annalisa:
```{r, eval = F}
if(!file.exists("labevents_icustays.csv.gz")){
  system.time(labevents_tab <- 
                fread(str_c(mimic_path, "/hosp/labevents.csv.gz"),
                      select = c("subject_id", "hadm_id", "itemid", 
                                 "charttime", "valuenum"), 
                      nThread = 4))
  labevents_tab %>%
    semi_join(icustays_tab, by = c("subject_id", "hadm_id")) %>%
    fwrite("labevents_icustays.csv.gz", nThread = 4)
}

system.time(labevents_tab <- fread("labevents_icustays.csv.gz"))
labevents_tab %>%
  as.tibble() %>%
  
  print(width = Inf)
```


```{r, eval=FALSE}
# 15 seconds, will take about 17 seconds with nThread = 1 (default)
labevents_tble <- fread("labevents_icustays.csv.gz", nThread = 4)

labevents_tble %>% 
  as_tibble() %>% 
  print(width = Inf)
```

Now we only want some lab item ids: read in the lab item dictionary
```{r, eval = FALSE}
dlabitmes_tble <- 
  read_csv(str_c(mimic_path, "/hosp/d_labitems.csv.gz")) %>% 
  print(width = Inf)
```

We can just use the codes provided in the homework assignment. and just keep the rows of the labevents that just have those labitemids.


## Q7. Vitals from chartered events

We are interested in the vitals for ICU patients: heart rate, mean and systolic blood pressure (invasive and noninvasive measurements combined), body temperature, SpO2, and respiratory rate.

`chartevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`d_items.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 


## Q8. Putting things together

Let us create a tibble for all ICU stays, where rows are  

- first ICU stay of each unique patient  
- adults (age at admission > 18)  ~ from the admission table

and columns contains at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz` 
- all the variables in `patients.csv.gz`
- first lab measurements during ICU stay  
- first vitals measurement during ICU stay  
- an indicator variable whether the patient died within 30 days of hospital admission  

only getting the first ICU stay of each unique patient:
```{r, eval = F}
icustays_tble %>% 
  # just keep first ICU stay for each unique subject id
  group_by(subject_id) %>% 
  slice_min(intime) %>% 
  # merge admissions tibble
  left_join(admissions_tble, by = c("subject_id", "hadm_id")) %>% 
  # merge patients tibble
  left_join(patients_tble, by = "subject_id") %>% 
  # only keep adults (age at admission >= 18)
  mutate(age_at_adm = year(admittime) - anchor_year + anchor_age) %>% 
  filter(age_at_adm >= 18) %>% 
  # want lab measurement for first ICU stay
  # look at labitem's chart time and make sure its between the intime and outime
  # for each subject id
  print(width = Inf) 
```
age at admission = anchor_year - admission_year + anchor_age

At the end of code, just show the first few observations of our final tibble.

